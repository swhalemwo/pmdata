<!-- --- -->
<!-- title: "artfacts" -->
<!-- output: rmarkdown::html_vignette -->
<!-- vignette: > -->
<!--   %\VignetteIndexEntry{example} -->
<!--   %\VignetteEngine{knitr::rmarkdown} -->
<!--   %\VignetteEncoding{UTF-8} -->
<!-- --- -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup,  echo = F, results = F, message = F}
library(pmdata)
library(data.table)
adt <- as.data.table
library(ggplot2)
library(collapse)
library(jtls)
library(countrycode)
library(purrr)
library(scales, include.only = "rescale")
library(ggrepel)
PMDATA_LOCS <- gc_pmdata_locs()
```

##  Merging Artfacts to PMDB

<!-- First we generate a bunch of objects that will help us later:  -->

```{r datat_prep, echo = F}
## get af exhibitions and institutions
dt_af_exhbs <- gd_af_exhbs()
dt_af_instns <- gd_af_instns()
dt_af_links_exhb_ppl <- gd_af_links_exhb_ppl()

## get PMDB
dt_pmdb <- suppressWarnings(gd_pmdb(gd_pmdb_excl(only_pms = F), verbose = NULL)) %>%    
    .[museum_status %in% c("private museum", "closed")]

## import match file
dt_matches_pmdb_af <- gd_af_pmdb_matches()

## compare coverage: 
dt_pmdb_af <- join(dt_matches_pmdb_af, dt_pmdb[, .(ID, name, iso3c, museum_status)],
                   on = c(PMDB_ID = "ID"), how = "inner", verbose = F)

```

Overall coverage (private museums in our database which are in our sample of the Artfacts database) is `r dt_pmdb_af[, 100*sum(AF_IID != "nomatch")/.N]`%. Differences by museum status exist, but are not very large: `r dt_pmdb_af[museum_status =="private museum", 100*sum(AF_IID != "nomatch")/.N]`% for open, `r dt_pmdb_af[museum_status =="closed", 100*sum(AF_IID != "nomatch")/.N]`% for closed.


<!-- ```{r af_cvrg, echo = F} -->
<!-- ## .[grepl("carmignac", name, ignore.case = T)] -->
<!-- dt_pmdb_af[, .N, .(museum_status, af_cvrg = fifelse(AF_IID != "nomatch", "AF_IID", "noAF_IID"))] %>% -->
<!--     .[, prop := N/sum(N), museum_status] %>% -->
<!--     .[, cell_fmtd :=sprintf("%s (%s %%)", N, format(100*prop, digits =2, nsmall = 2 ,))] %>% -->
<!--     dcast(af_cvrg ~ museum_status, value.var = "cell_fmtd") -->
    
<!-- ``` -->



```{r, echo = F}
## calculate AF coverage by country and museum status
dt_pmdb_af_cvrgvis <- dt_pmdb_af[, .N, .(museum_status, iso3c, AF_IID != "nomatch")] %>%
    ## expand DT by all possible combinations
    .[CJ(AF_IID, iso3c, museum_status, unique = T), on = .(iso3c, AF_IID, museum_status)] %>%
    replace_NA(value = 0) %>%  # make values of combination not covered in the data 0
    .[, N_cry_ms := sum(N), .(museum_status, iso3c)] %>% # count per country and museum status (ms)
    .[, prop_covered := N/N_cry_ms] %>% # prop with AF_IID (by country and museum_status)
    .[AF_IID == TRUE] %>% # only focus on covered percentages (not covered is 1- covered)
    .[, museum_status := factor(museum_status, levels = c("private museum", "closed"))] %>% 
    .[order(museum_status, prop_covered)] %>%  # reorder in for ggplot
    .[, iso3c := factor(iso3c, funique(iso3c))] %>%
    .[, reg6 := rcd_iso3c_reg6(iso3c)] %>%
    .[!is.nan(prop_covered)] # %>% .[iso3c == "DEU"]
```

Coverage by region: 

```{r, fig.dim = c(8, 8), echo = F}
## coverage by  region
dt_pmdb_af %>% copy() %>% 
    .[, reg_sub := countrycode(iso3c, "iso3c", "un.regionsub.name",
                               custom_match = c(TWN = "South-eastern Asia"))] %>%
    .[, reg6 := rcd_iso3c_reg6(iso3c)] %>% 
    .[, .N, .(museum_status, reg_sub, reg6, AF_IID != "nomatch")] %>%
    .[, prop_covered := N/sum(N), .(museum_status, reg_sub, reg6)] %>% 
    .[AF_IID == TRUE] %>%
    .[, museum_status := factor(museum_status, levels = c("private museum", "closed"))] %>%
    .[order(museum_status, prop_covered)] %>% .[, reg_sub := factor(reg_sub, funique(reg_sub))] %>% 
    ggplot(aes(x=prop_covered, y=reg_sub, group = museum_status, color = museum_status, fill = museum_status)) +
    geom_col(position = position_dodge2(preserve = "single")) +
    ## geom_point() + 
    facet_grid(reg6 ~ ., scales = "free", space = "free")
```

Europe seems to be covered best, Souther Asia worst (not all regions have museums which have closed, which is why not all bars are present). 


Coverage also differs by country: 


```{r,  fig.dim = c(8,9),  echo = F}
dt_pmdb_af_cvrgvis %>% 
    ggplot(aes(x = prop_covered, y = iso3c, color = museum_status, group = museum_status, size = N_cry_ms)) +
    geom_point(position = position_dodge(width = 0.8)) +
    geom_text(mapping = aes(label = N_cry_ms),
              position = position_dodge(width = 0.8),
              color = "black",
              ## manually scale font size to make it fit in the bubbles
              size = dt_pmdb_af_cvrgvis[order(reg6), rescale(N_cry_ms, to = c(2, 4))]) + 
    facet_grid(reg6 ~ ., scales = "free_y", space = "free_y") +
    scale_size_continuous(range = c(2,6))
``` 


European countries seem to be covered best (e.g. almost three quarters of Germany's 60 open museums are covered, compared to lesss than half of South Korea's 50). 

Closed museums are also not covered well in Asia, e.g. none of the closed museums in 7 Asian countries are included, compared to only 1 European country and 1 African. 

<!-- Alternative way of plotting country coverage, but doesn't look so good:  -->

<!-- ```{r, fig.dim = c(10,8), echo = F} -->
<!-- ##  -->
<!-- dt_pmdb_af_cvrgvis %>% copy() %>% -->
<!--     .[, museum_status_short := fifelse(museum_status == "closed", "CL", "OP")] %>% -->
<!--     .[, lbl := sprintf("%s -  %s", iso3c, museum_status_short)] %>%  -->
<!--     ggplot(aes(x=N_cry_ms, y = prop_covered, color = museum_status, label = iso3c)) + -->
<!--     geom_point() + -->
<!--     geom_text_repel(box.padding = 0.1, force_pull = 0) -->

<!-- ``` -->

## Artfacts coverage over time 

```{r, echo = F}
## merge AF exhibitions to PMDB
dt_pmdb_exhbs <- join(dt_af_exhbs,
     dt_pmdb_af[AF_IID != "nomatch", .(InstitutionID = as.integer(AF_IID), PMDB_ID, name)], 
     on = "InstitutionID", how = 'inner', verbose = 0) %>%
    .[, begin_year := year(BeginDate)]

dt_af_exhbs_pmdb <- join(dt_af_exhbs,
                         dt_pmdb_af[AF_IID != "nomatch", .(InstitutionID = as.integer(AF_IID), PMDB_ID, name)],
                         on = "InstitutionID", how = 'left', verbose = 0) %>%
    .[, begin_year := year(BeginDate)]
```

Around `r format(100*(fnrow(dt_pmdb_exhbs)/fnrow(dt_af_exhbs)), digits = 2, nsmall = 2)` % of exhibitions in Artfacts are in private museums. 


percentage of shows in private museums over time: increases quite over time

```{r, fig.dim = c(8, 6), echo = F}
dt_af_exhbs_pmdb[, .(prop_pmdb = sum(100*!is.na(PMDB_ID))/.N), begin_year] %>%
    .[begin_year %between% c(1990, 2023)] %>% 
    ggplot(aes(x=begin_year, y = prop_pmdb)) + geom_line()
```

distribution of types of institutions and exhibitions


```{r, echo = F}
## get exhibition data with institution info (w, i, info)
dt_af_exhbs_wiinfo <- join(dt_af_exhbs, dt_af_instns, on = c(InstitutionID = "ID"), verbose = F) %>%
    .[, begin_year := year(BeginDate)]

dt_af_t_itype <- dt_af_exhbs_wiinfo[, .(nbr_type = fnunique(InstitutionID), nbr_exhbs = .N), InstitutionType] %>%
    .[, `:=`(perc_type = 100*nbr_type/sum(nbr_type), perc_exhbs = 100*nbr_exhbs/sum(nbr_exhbs))] %>%
    .[order(-nbr_exhbs)]
```

```{r}
dt_af_t_itype %>% print(n=25, row.names = F, width = 60)
```
Most exhibitions are in Galleries, Public Instititutions and NPOs.

type over time: 

```{r, fig.dim = c(9,6), echo = F}

rbind(
    dt_af_exhbs_wiinfo[, .N, .(InstitutionType, begin_year)] %>%
    .[begin_year %between% c(1990, 2022)] %>%
    .[, .SD[any(N > 150)], InstitutionType] %>% # only types which at least once gets 150 exhbs per year
    .[order(-N)] %>% .[, InstitutionType := factor(InstitutionType, levels = funique(InstitutionType))] %>%
    .[, src := "type"],
    dt_af_exhbs_wiinfo %>% # aggregate total 
    .[begin_year %between% c(1990, 2022)] %>%
    .[, .N, begin_year] %>% .[, `:=`(src = "total", InstitutionType = "all")]) %>% 
    ggplot(aes(x=begin_year, y=N, color = InstitutionType)) + geom_line()
```

huh some decrease by more than 50% from ~2012 onwards? 

could be that coverage changes over time by: 

- country: some countries get covered less

- artist: some artists get covered less -> exhibition numbers of active artists can stay stable/go up even when total number decreases

- institution: some institutions get covered less: average exhibition numbers of active institutions can be stable/go up even when total number decreases



```{r, fig.dim = c(9, 8), echo = F}
## artfacts exhb with people info 
dt_af_exhbs_wpinfo <- join(dt_af_links_exhb_ppl, dt_af_exhbs_wiinfo, on = c(ExhibitionID = "ID"), verbose = 0)
```




by country: 

```{r, fig.dim = c(12, 8), echo = F}
## count over time by institution type and country 
dt_af_exhbs_wiinfo[, .N, .(InstitutionType, begin_year, CountryName)] %>%
    .[begin_year %between% c(1990, 2022)] %>%
    .[, .SD[any(N > 75)], .(InstitutionType, CountryName)] %>%
    .[order(-N)] %>% .[, CountryName := factor(CountryName, levels = funique(CountryName))] %>% 
    ggplot(aes(x=begin_year, y = N, color = InstitutionType)) +
    geom_line() +
    facet_wrap(~ CountryName, scales = "free_y") +
    theme(strip.text = element_text(margin = margin(0,0,0,0, "cm")),
          legend.position = "bottom",
          axis.text.x = element_text(angle = 20))
          
```

pretty much in all countries, both big and small (ordered by max size)


is that decrease a within-institution effect? or "closures", i.e. exclusion? -> look at average numbers

```{r, fig.dim = c(10, 6), echo = F}
rbind(
    ## average number of exhibitions by InstitutionType
    dt_af_exhbs_wiinfo[, .N, .(InstitutionType, begin_year, InstitutionID)] %>%
    .[begin_year %between% c(1990, 2022), .SD[any(sum(N) > 2000)], .(InstitutionType)] %>%
    .[, .(vlu = mean(N), measure = "instn_avg_exhbcnt"), .(InstitutionType, begin_year)],
    ## number of unique Institutions per type and year
    dt_af_exhbs_wiinfo[, .(vlu = fnunique(InstitutionID), measure = "instn_unq_cnt"),
                       .(InstitutionType, begin_year)] %>%
    .[begin_year %between% c(1990, 2022), .SD[any(sum(vlu) > 2000)], .(InstitutionType)],
    ## average number of exhibitions for an artist in institution type per year
    dt_af_exhbs_wpinfo[, .N, .(PeopleID, begin_year, InstitutionType)] %>%
    .[begin_year %between% c(1990, 2022), .SD[any(sum(N) > 10000)], .(InstitutionType)] %>%
    .[, .(vlu = mean(N), measure = "artist_avg_exhbcnt"), .(begin_year, InstitutionType)],
    ## Artist data
    dt_af_exhbs_wpinfo[begin_year %between% c(1990, 2022)] %>%
    .[, .(artist_unq_cnt = fnunique(PeopleID), artist_ttl_cnt = .N), .(InstitutionType, begin_year)] %>%
    .[, .SD[any(artist_unq_cnt > 500)], InstitutionType] %>% 
    melt(id.vars = c("InstitutionType", "begin_year"), variable.name = "measure", value.name = "vlu")) %>%
    ## categorize some more
    .[, `:=`(entity = factor(fifelse(grepl("^instn", measure), "instn", "artist"), levels = c("instn", "artist")),
             measure2 = gsub("artist_|instn_", "", measure))] %>%
    ggplot(aes(x=begin_year, y=vlu, color = InstitutionType)) +
    geom_line() +
    facet_wrap(entity ~ measure2, scales = "free") +
    theme(legend.position = "bottom")
```

seems to be in all kinds of settings: declines from ~2012 onwards in all: 

- instititutions: 
    - number with at least 1 show (instn, unq_cnt)
    - average number of exhibitions by active institutions (instn, avg_exhbcnt)

- artists: 
    - number of artists exhibited in total (artist, ttl_cnt)
    - number of unique artists exhibited (artist, unq_cnt)
    - average number of exhibitions (artist, avg_exhbcnt)


possible explanations: 

- data collection: 
  Artfacts data collection has become less complete since 2012? but weird that it's so gradual  
  change in availability in their sources?  
  data processing errors on their part?  


- substantial: art field has shrunk since 2012?  
  look at auction data? 

way to deal with it for PM size indicator: 

- rather than count of exhibitions, percent of total exhibitions?  
  this has the funny/undesirable property that it shrinks if exhibition count stays the same, but more museums are added
  
- rank: e.g. which decile  
  same issue: by more other museums doing more, rank can go down
  
<!-- AF: founded in 2001 -->
<!-- https://web.archive.org/web/20240000000000*/artfacts.net: less active in period 2014-2017 -->
<!-- website look same tho -->
